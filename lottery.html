<script>

document.getElementById("closeBtn").onclick = function(){
  if(window.parent && window.parent.closeGame){
    window.parent.closeGame();
  } else {
    window.history.back();
  }
};

document.getElementById("revealBtn").onclick = function(){
  window.open("https://eGft.in/p~eHfO0iGRXWSCq","_blank");
};

const symbols = [
"heart.png",
"spade.png",
"diamond.png",
"star.png",
"ring.png",
"crown.png"
];

const scriptedResults = {
1:["spade.png","ring.png","diamond.png"],
2:["ring.png","star.png","crown.png"],
3:["heart.png","ring.png","star.png"],
bonus:["heart.png","heart.png","heart.png"]
};

let attempt = 1;
let spinning = false;
let spinInterval;
let state = "normal";
let audioUnlocked = false;

const slot1 = document.getElementById("slot1");
const slot2 = document.getElementById("slot2");
const slot3 = document.getElementById("slot3");
const stopBtn = document.getElementById("stopBtn");
const bonusBox = document.getElementById("bonusBox");
const revealBtn = document.getElementById("revealBtn");

const romanticSound = document.getElementById("romanticSound");
const spinSound = document.getElementById("spinSound");
const stopSound = document.getElementById("stopSound");
const winSound = document.getElementById("winSound");

romanticSound.volume = 0.15;

function unlockAudio(){
  if(audioUnlocked) return;

  romanticSound.play().catch(()=>{});
  romanticSound.pause();
  romanticSound.currentTime = 0;

  spinSound.play().catch(()=>{});
  spinSound.pause();
  spinSound.currentTime = 0;

  stopSound.play().catch(()=>{});
  stopSound.pause();
  stopSound.currentTime = 0;

  winSound.play().catch(()=>{});
  winSound.pause();
  winSound.currentTime = 0;

  romanticSound.play().catch(()=>{});
  audioUnlocked = true;
}

function randomSymbol(){
  return symbols[Math.floor(Math.random()*symbols.length)];
}

function startSpinning(){
  spinning = true;

  if(audioUnlocked){
    spinSound.currentTime = 0;
    spinSound.play().catch(()=>{});
  }

  spinInterval = setInterval(()=>{
    slot1.src = randomSymbol();
    slot2.src = randomSymbol();
    slot3.src = randomSymbol();
  },100);
}

function stopSpinning(){
  clearInterval(spinInterval);
  spinning = false;

  spinSound.pause();
  spinSound.currentTime = 0;
}

function activateButton(){
  stopBtn.disabled = false;
  stopBtn.className="active";
}

function deactivateButton(){
  stopBtn.disabled = true;
  stopBtn.className="inactive";
}

function nextAttemptFlow(){
  attempt++;

  if(attempt<=3){
    document.getElementById("attempt").innerText="Attempt "+attempt+" / 3";

    setTimeout(()=>{
      startSpinning();
      setTimeout(()=>activateButton(),2000);
    },2000);
  }
  else{
    showBonusFlow();
  }
}

function showBonusFlow(){

  bonusBox.style.display="block";
  bonusBox.innerText="Attempts over. Please try again tomorrow.";

  setTimeout(()=>{
    bonusBox.innerText=
    "But you have been such a nice, caring and loving girlfriend...\nYou deserve all the love and happiness";
  },12000);

  setTimeout(()=>{
    bonusBox.innerText="Here is a bonus attempt";
  },19000);

  setTimeout(()=>{
    bonusBox.style.display="none";
    document.getElementById("attempt").innerText="Attempt: Love / Everything";
    state="bonus";
    startSpinning();
    setTimeout(()=>activateButton(),2000);
  },24000);
}

stopBtn.onclick=function(){

  unlockAudio();   // ðŸ‘ˆ THIS FIXES EVERYTHING

  if(!spinning) return;

  deactivateButton();
  stopSpinning();

  stopSound.currentTime = 0;
  stopSound.play().catch(()=>{});

  if(state==="bonus"){
    slot1.src=scriptedResults.bonus[0];
    slot2.src=scriptedResults.bonus[1];
    slot3.src=scriptedResults.bonus[2];

    winSound.currentTime = 0;
    winSound.play().catch(()=>{});

    document.getElementById("message").innerText=
    "Winner ðŸ’– You won the lottery.\nThe prize is your loving and caring boyfriend for lifetime.";

    setTimeout(()=>{
      revealBtn.style.display="inline-block";
    },5000);

    return;
  }

  slot1.src=scriptedResults[attempt][0];
  slot2.src=scriptedResults[attempt][1];
  slot3.src=scriptedResults[attempt][2];

  nextAttemptFlow();
};

startSpinning();
activateButton();

</script>
